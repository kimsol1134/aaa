#!/usr/bin/env python3
"""
노트북 02_고급_도메인_특성공학.ipynb에 추가 설명을 넣는 스크립트
"""

import json
import sys

def add_descriptions(notebook_path):
    """노트북에 상세 설명 추가"""

    # 노트북 로드
    with open(notebook_path, 'r', encoding='utf-8') as f:
        notebook = json.load(f)

    cells = notebook['cells']

    print(f"원본 셀 개수: {len(cells)}")

    # 1. 섹션 1에 더 상세한 설명 추가
    print("\n1. 섹션 1 설명 보완...")
    for i, cell in enumerate(cells):
        if cell['cell_type'] == 'markdown':
            source = ''.join(cell.get('source', []))
            if '## 1. 환경 설정 및 데이터 로딩' in source:
                cells[i]['source'] = [
                    "## 1. 환경 설정 및 데이터 로딩\n",
                    "\n",
                    "### 📦 필요한 라이브러리\n",
                    "\n",
                    "- **pandas**: 데이터 처리 및 특성 생성\n",
                    "- **numpy**: 수치 계산 및 무한대 값 처리\n",
                    "- **sklearn**: StandardScaler (정규화), RandomForestClassifier (특성 중요도)\n",
                    "\n",
                    "### 📊 원본 데이터\n",
                    "\n",
                    "- 파일: `data/기업신용평가정보_210801.csv`\n",
                    "- 기업 수: 50,105개\n",
                    "- 변수 수: 159개 (재무/신용 변수)\n",
                    "- 타겟 변수: `모형개발용Performance(향후1년내부도여부)`\n",
                    "- 부도율: ~1.5% (불균형 데이터)\n"
                ]
                print(f"   - 섹션 1 설명 추가 완료")
                break

    # 2. 섹션 2에 실무 사례 추가
    print("2. 섹션 2 설명 보완...")
    for i, cell in enumerate(cells):
        if cell['cell_type'] == 'markdown':
            source = ''.join(cell.get('source', []))
            if '## 2. 유동성 위기 조기 감지 특성' in source:
                cells[i]['source'] = [
                    "## 2. 유동성 위기 조기 감지 특성\n",
                    "\n",
                    "### 💡 왜 유동성이 가장 중요한가?\n",
                    "\n",
                    "**경제적 가설: \"부도는 지급불능이 아닌 유동성 위기로 시작된다\"**\n",
                    "\n",
                    "**학술적 배경 (Whitaker 1999):**\n",
                    "- 부도 기업의 **67%는 흑자**였음 (장부상 이익 발생)\n",
                    "- 하지만 **현금이 없어서** 급여/세금/이자를 지급하지 못함\n",
                    "- 유동성 위기는 부도 **3~6개월 전**에 나타남\n",
                    "\n",
                    "**실무 사례:**\n",
                    "```\n",
                    "건설업체 A사:\n",
                    "- 영업이익: 100억 (흑자) ✅\n",
                    "- 현금및현금성자산: 5억 ❌\n",
                    "- 단기차입금: 200억 (3개월 내 만기) ❌\n",
                    "- 즉각지급능력 = 5 / 200 = 0.025 (2.5%) → 위험!\n",
                    "- 결과: 2개월 후 부도\n",
                    "```\n",
                    "\n",
                    "### 생성할 10개 유동성 특성\n",
                    "\n",
                    "| 특성 | 의미 | 임계값 |\n",
                    "|------|------|--------|\n",
                    "| 즉각지급능력 | 현금 / 단기부채 | < 0.1 위험 |\n",
                    "| 현금소진일수 | 현금 / 일평균지출 | < 30일 위험 |\n",
                    "| 운전자본비율 | (유동자산-유동부채) / 총자산 | < 0 위험 |\n",
                    "| 당좌비율 | (유동자산-재고) / 유동부채 | < 1.0 주의 |\n",
                    "| 현금비율 | 현금 / 유동부채 | < 0.2 주의 |\n",
                    "| 유동성갭 | 유동자산 - 유동부채 | < 0 위험 |\n",
                    "| 단기부채비중 | 단기부채 / 총부채 | > 0.5 주의 |\n",
                    "| 현금흐름대비부채 | 총부채 / 영업현금흐름 | > 5 위험 |\n",
                    "| 긴급유동성 | 초유동자산 / 유동부채 | < 0.5 주의 |\n",
                    "| 운전자본회전율 | 매출 / 운전자본 | < 1 주의 |\n"
                ]
                print(f"   - 섹션 2 설명 추가 완료")
                break

    # 3. 섹션 3에 실무 사례 추가
    print("3. 섹션 3 설명 보완...")
    for i, cell in enumerate(cells):
        if cell['cell_type'] == 'markdown':
            source = ''.join(cell.get('source', []))
            if '## 3. 지급불능 패턴 특성' in source:
                cells[i]['source'] = [
                    "## 3. 지급불능 패턴 특성\n",
                    "\n",
                    "### 💡 유동성 위기 vs 지급불능\n",
                    "\n",
                    "**차이점:**\n",
                    "- **유동성 위기**: 일시적 현금 부족 (단기 문제)\n",
                    "- **지급불능**: 구조적 부채 초과 (장기 문제)\n",
                    "\n",
                    "**경제적 가설: \"자본잠식 + 과다부채 = 회생 불가능\"**\n",
                    "\n",
                    "**실무 사례:**\n",
                    "```\n",
                    "제조업체 B사:\n",
                    "- 총자산: 500억\n",
                    "- 총부채: 600억 (부채비율 120%)\n",
                    "- 자본: -100억 (완전자본잠식) ❌\n",
                    "- 이자비용: 30억/년\n",
                    "- 영업이익: 10억/년\n",
                    "- 이자보상배율 = 10 / 30 = 0.33 < 1 ❌\n",
                    "- 결과: 이자도 갚지 못함 → 6개월 후 부도\n",
                    "```\n",
                    "\n",
                    "### 생성할 8개 지급불능 특성\n",
                    "\n",
                    "| 특성 | 의미 | 임계값 |\n",
                    "|------|------|--------|\n",
                    "| 자본잠식도 | 음의 자본 비율 | > 0 위험 |\n",
                    "| 이자보상배율 | 영업이익 / 이자비용 | < 1 위험 |\n",
                    "| 부채상환년수 | 총부채 / 영업현금흐름 | > 10년 위험 |\n",
                    "| 재무레버리지 | 총자산 / 자기자본 | > 5 주의 |\n",
                    "| 단기부채비중 | 단기부채 / 총부채 | > 0.7 주의 |\n",
                    "| 고정장기적합률 | 비유동자산 / 장기자본 | > 1.2 주의 |\n",
                    "| 부채비율 | 총부채 / 자기자본 | > 200% 주의 |\n",
                    "| 차입금의존도 | 차입금 / 총자산 | > 0.5 주의 |\n"
                ]
                print(f"   - 섹션 3 설명 추가 완료")
                break

    # 4. 섹션 4에 M-Score 설명 추가
    print("4. 섹션 4 설명 보완...")
    for i, cell in enumerate(cells):
        if cell['cell_type'] == 'markdown':
            source = ''.join(cell.get('source', []))
            if '## 4. 재무조작 탐지 특성 (Beneish M-Score 한국형)' in source:
                cells[i]['source'] = [
                    "## 4. 재무조작 탐지 특성 (Beneish M-Score 한국형)\n",
                    "\n",
                    "### 💡 왜 재무조작 탐지가 필요한가?\n",
                    "\n",
                    "**경제적 가설: \"부도 직전 기업은 실적을 부풀린다\"**\n",
                    "\n",
                    "**학술적 배경 (Beneish 1999):**\n",
                    "- **M-Score**: 재무제표 조작 가능성을 수치화한 지표\n",
                    "- 8개 재무 비율의 가중합으로 계산\n",
                    "- M-Score > -2.22: 조작 의심 (76% 정확도)\n",
                    "\n",
                    "**한국형 M-Score 조정:**\n",
                    "- 외부감사 여부 반영 (한국 시장 특성)\n",
                    "- 중소기업 특성 반영 (회계 품질 차이)\n",
                    "\n",
                    "**실제 사례 (대우조선해양 2015):**\n",
                    "```\n",
                    "- 매출채권 급증 (DSRI↑): 가공 매출 의심\n",
                    "- 매출총이익률 급증 (GMI↑): 원가 조작 의심\n",
                    "- 발생액 비정상 (TATA↑): 현금 없는 이익 의심\n",
                    "- M-Score > -2.22 → 조작 의심\n",
                    "- 결과: 2015년 분식회계 적발\n",
                    "```\n",
                    "\n",
                    "### Beneish M-Score 8개 구성 요소\n",
                    "\n",
                    "| 지표 | 의미 | 조작 신호 |\n",
                    "|------|------|----------|\n",
                    "| DSRI | 매출채권 / 매출 증가율 | 높을수록 가공매출 의심 |\n",
                    "| GMI | 매출총이익률 변화 | 감소 시 조작 가능성 |\n",
                    "| AQI | 자산 품질 지수 | 높을수록 자산 부풀리기 의심 |\n",
                    "| SGI | 매출 성장률 | 과도한 성장 시 의심 |\n",
                    "| DEPI | 감가상각률 변화 | 감소 시 이익 부풀리기 의심 |\n",
                    "| SGAI | 판관비 / 매출 변화 | 증가 시 비효율 의심 |\n",
                    "| LVGI | 레버리지 증가율 | 증가 시 재무위험 증가 |\n",
                    "| TATA | 발생액 / 총자산 | 높을수록 현금 없는 이익 의심 |\n",
                    "\n",
                    "**M-Score 계산식:**\n",
                    "```\n",
                    "M-Score = -4.84 + 0.92*DSRI + 0.528*GMI + 0.404*AQI + 0.892*SGI \n",
                    "          + 0.115*DEPI - 0.172*SGAI + 4.679*TATA - 0.327*LVGI\n",
                    "\n",
                    "해석:\n",
                    "- M-Score > -2.22: 조작 가능성 높음\n",
                    "- M-Score ≤ -2.22: 정상\n",
                    "```\n"
                ]
                print(f"   - 섹션 4 설명 추가 완료")
                break

    # 5. 섹션 8에 상호작용 설명 추가
    print("5. 섹션 8 설명 보완...")
    for i, cell in enumerate(cells):
        if cell['cell_type'] == 'markdown':
            source = ''.join(cell.get('source', []))
            if '## 8. 비선형 관계 및 상호작용 특성' in source:
                cells[i]['source'] = [
                    "## 8. 비선형 관계 및 상호작용 특성\n",
                    "\n",
                    "### 💡 왜 비선형 및 상호작용이 중요한가?\n",
                    "\n",
                    "**경제적 가설: \"위험 요인은 단독이 아닌 결합으로 작동한다\"**\n",
                    "\n",
                    "**실무 사례:**\n",
                    "```\n",
                    "Case 1: 부채비율 300% + ROA 15%\n",
                    "- 높은 부채지만 수익성 우수 → 안전 ✅\n",
                    "\n",
                    "Case 2: 부채비율 300% + ROA -5%\n",
                    "- 높은 부채 + 적자 → 매우 위험 ❌❌\n",
                    "```\n",
                    "\n",
                    "**비선형 관계:**\n",
                    "- 부채비율 < 100%: 안전\n",
                    "- 부채비율 100~200%: 주의\n",
                    "- 부채비율 > 200%: 위험 급증 (제곱 효과)\n",
                    "\n",
                    "### 생성할 3개 상호작용 특성\n",
                    "\n",
                    "| 특성 | 의미 | 해석 |\n",
                    "|------|------|------|\n",
                    "| 레버리지_수익성_상호작용 | 부채비율 × ROA | 부채가 높을 때 수익성이 더 중요 |\n",
                    "| 부채비율_제곱 | (부채비율)² | 과다부채의 비선형 위험 포착 |\n",
                    "| 임계값기반_복합지표 | 임계값 초과 횟수 | 다중 위험 신호 감지 |\n",
                    "\n",
                    "**예시: 레버리지_수익성_상호작용**\n",
                    "```\n",
                    "기업 A: 부채비율 50% × ROA 10% = 5\n",
                    "기업 B: 부채비율 300% × ROA 10% = 30\n",
                    "기업 C: 부채비율 300% × ROA -5% = -15 ← 매우 위험!\n",
                    "```\n"
                ]
                print(f"   - 섹션 8 설명 추가 완료")
                break

    # 6. 섹션 10에 특성 중요도 설명 추가
    print("6. 섹션 10 설명 보완...")
    for i, cell in enumerate(cells):
        if cell['cell_type'] == 'markdown':
            source = ''.join(cell.get('source', []))
            if '## 10. 특성 중요도 초기 평가' in source:
                cells[i]['source'] = [
                    "## 10. 특성 중요도 초기 평가\n",
                    "\n",
                    "### 🎯 목적\n",
                    "\n",
                    "생성한 65개 도메인 특성 중 **실제로 부도 예측에 유용한 특성**을 식별합니다.\n",
                    "\n",
                    "**평가 방법:**\n",
                    "- **RandomForestClassifier**: 트리 기반 특성 중요도 (Gini Importance)\n",
                    "- **불균형 데이터 처리**: class_weight='balanced' 적용\n",
                    "- **Top 30 특성**: 가장 중요한 상위 30개 특성 선별\n",
                    "\n",
                    "**특성 중요도 해석:**\n",
                    "- 높은 중요도 → 부도 예측에 강한 영향\n",
                    "- 낮은 중요도 → 제거 고려 (차원 축소)\n",
                    "\n",
                    "**다음 단계:**\n",
                    "- `03_상관관계_및_리스크_패턴_분석.ipynb`에서 더 정교한 특성 선택 수행\n",
                    "- 상관관계 분석 → 중복 특성 제거\n",
                    "- 최종적으로 ~40개 특성으로 축소\n"
                ]
                print(f"   - 섹션 10 설명 추가 완료")
                break

    # 수정된 노트북 저장
    notebook['cells'] = cells

    print(f"\n수정 후 셀 개수: {len(cells)}")

    with open(notebook_path, 'w', encoding='utf-8') as f:
        json.dump(notebook, f, ensure_ascii=False, indent=1)

    print(f"\n✅ 노트북 설명 추가 완료: {notebook_path}")

    return True


if __name__ == "__main__":
    notebook_path = "../notebooks/02_고급_도메인_특성공학.ipynb"

    try:
        add_descriptions(notebook_path)
    except Exception as e:
        print(f"❌ 오류 발생: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
