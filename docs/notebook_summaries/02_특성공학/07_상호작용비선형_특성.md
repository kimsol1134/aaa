## 8. 비선형 관계 및 상호작용 특성

### 💡 왜 비선형 및 상호작용이 중요한가?

**경제적 가설: "위험 요인은 단독이 아닌 결합으로 작동한다"**

**실무 사례:**
```
Case 1: 부채비율 300% + ROA 15%
- 높은 부채지만 수익성 우수 → 안전 ✅

Case 2: 부채비율 300% + ROA -5%
- 높은 부채 + 적자 → 매우 위험 ❌❌
```

**비선형 관계:**
- 부채비율 < 100%: 안전
- 부채비율 100~200%: 주의
- 부채비율 > 200%: 위험 급증 (제곱 효과)

### 생성할 3개 상호작용 특성

| 특성 | 의미 | 해석 |
|------|------|------|
| 레버리지_수익성_상호작용 | 부채비율 × ROA | 부채가 높을 때 수익성이 더 중요 |
| 부채비율_제곱 | (부채비율)² | 과다부채의 비선형 위험 포착 |
| 임계값기반_복합지표 | 임계값 초과 횟수 | 다중 위험 신호 감지 |

**예시: 레버리지_수익성_상호작용**
```
기업 A: 부채비율 50% × ROA 10% = 5
기업 B: 부채비율 300% × ROA 10% = 30
기업 C: 부채비율 300% × ROA -5% = -15 ← 매우 위험!
```


### 코드 셀 #12

```python
def create_interaction_features(df, features_dict):
    """주요 변수 간 상호작용 효과를 포착하는 특성 생성"""
    
    interactions = pd.DataFrame(index=df.index)
    
    # 1. 레버리지 × 수익성 상호작용
    if '부채비율' in df.columns and 'ROE' in df.columns:
        interactions['레버리지_수익성_상호작용'] = (df['부채비율'] / 100) * (df['ROE'] / 100)
        interactions['고레버리지_저수익'] = ((df['부채비율'] > 200) & (df['ROE'] < 0)).astype(int)
    
    # 2. 유동성 × 성장 상호작용
    if '유동비율' in df.columns and '매출액' in df.columns:
        매출성장률 = df['매출액'] / df['매출액'].median() - 1
        interactions['유동성_성장_상호작용'] = df['유동비율'] * 매출성장률
    
    # 3. 규모 × 효율성 상호작용
    if '기업규모_로그' in features_dict['korean'].columns and '총자산회전율' in df.columns:
        interactions['규모_효율성_상호작용'] = features_dict['korean']['기업규모_로그'] * df['총자산회전율']
    
    # 4. 업종 × 재무비율 상호작용
    if '제조업_레버리지위험' in features_dict['korean'].columns:
        interactions['제조업_부채위험'] = features_dict['korean']['제조업_레버리지위험']
    
    # 5. 비선형 변환
    if '부채비율' in df.columns:
        interactions['부채비율_제곱'] = (df['부채비율'] / 100) ** 2
        interactions['부채비율_로그'] = np.log1p(df['부채비율'].abs())
    
    if '현금비율' in df.columns:
        interactions['현금비율_제곱근'] = np.sqrt(df['현금비율'].abs())
    
    # 6. 임계값 기반 특성
    if '이자보상배율' in features_dict['insolvency'].columns:
        interactions['이자보상_임계'] = (features_dict['insolvency']['이자보상배율'] < 1).astype(int)
    
    if '운전자본' in features_dict['liquidity'].columns:
        interactions['운전자본_음수'] = (features_dict['liquidity']['운전자본'] < 0).astype(int)
    
    print(f"✅ 상호작용 및 비선형 특성 {interactions.shape[1]}개 생성 완료")
    return interactions

features_dict = {
    'liquidity': liquidity_features,
    'insolvency': insolvency_features,
    'manipulation': manipulation_features,
    'korean': korean_features,
    'stakeholder': stakeholder_features
}

interaction_features = create_interaction_features(df, features_dict)
```

**출력:**

```
✅ 상호작용 및 비선형 특성 3개 생성 완료
```

---

### 코드 셀 #13

```python
# 상호작용 및 비선형 특성 생성
interaction_features_dict = {
    'liquidity': liquidity_features,
    'insolvency': insolvency_features,
    'profitability': profitability_activity_features
}

interaction_features = create_interaction_features(df, interaction_features_dict)
print(f"\n✅ 상호작용/비선형 특성 {interaction_features.shape[1]}개 생성 완료")
print("\n생성된 상호작용/비선형 특성:")
print(interaction_features.columns.tolist())

```

---

## 9. 특성 저장 및 메타데이터 생성

### 💾 생성된 특성 저장

모든 도메인 특성을 CSV 파일로 저장하고, 각 특성의 메타데이터를 기록합니다.


### 코드 셀 #14

```python
# 생성된 특성을 CSV 파일로 저장
output_path = '../data/features/domain_based_features.csv'
final_features.to_csv(output_path, index=False, encoding='utf-8-sig')
print(f"\n✅ 도메인 기반 특성이 {output_path}에 저장되었습니다.")

# 특성 메타데이터 저장
feature_metadata = pd.DataFrame({
    'category': (
        ['liquidity'] * liquidity_features.shape[1] +
        ['insolvency'] * insolvency_features.shape[1] +
        ['manipulation'] * manipulation_features.shape[1] +
        ['korean'] * korean_features.shape[1] +
        ['stakeholder'] * stakeholder_features.shape[1] +
        ['growth'] * growth_features.shape[1] +
        ['profitability_activity'] * profitability_activity_features.shape[1] +
        ['composite'] * composite_features.shape[1] +
        ['interaction'] * interaction_features.shape[1]
    ),
    'feature_name': all_features.columns.tolist(),
    'importance': feature_importance.set_index('feature')['importance'].reindex(all_features.columns).values
})

metadata_path = '../data/features/feature_metadata.csv'
feature_metadata.to_csv(metadata_path, index=False, encoding='utf-8-sig')
print(f"✅ 특성 메타데이터가 {metadata_path}에 저장되었습니다.")
```

---

## 10. 특성 중요도 초기 평가

### 🎯 목적

생성한 65개 도메인 특성 중 **실제로 부도 예측에 유용한 특성**을 식별합니다.

**평가 방법:**
- **RandomForestClassifier**: 트리 기반 특성 중요도 (Gini Importance)
- **불균형 데이터 처리**: class_weight='balanced' 적용
- **Top 30 특성**: 가장 중요한 상위 30개 특성 선별

**특성 중요도 해석:**
- 높은 중요도 → 부도 예측에 강한 영향
- 낮은 중요도 → 제거 고려 (차원 축소)

**다음 단계:**
- `03_상관관계_및_리스크_패턴_분석.ipynb`에서 더 정교한 특성 선택 수행
- 상관관계 분석 → 중복 특성 제거
- 최종적으로 ~40개 특성으로 축소


### 코드 셀 #15

```python
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import roc_auc_score, average_precision_score

# 타겟과 특성 분리
X = all_features.copy()
y = df[target_col]

# -------------------------------------------------------------------------
# [수정된 부분] 범주형 변수 처리 (에러 해결 핵심)
# '위험경보등급'이 범주형(Category)이라서 median 계산 및 모델 학습 시 에러 발생
# -> 숫자로 변환 (정상:0, 주의:1, 경고:2, 위험:3)
# -------------------------------------------------------------------------
if '위험경보등급' in X.columns:
    # cat.codes는 -1(NaN), 0, 1, 2... 로 변환됨
    X['위험경보등급'] = X['위험경보등급'].cat.codes
    # 혹시 모를 -1(NaN) 값을 0으로 처리하거나 적절히 대체
    X['위험경보등급'] = X['위험경보등급'].replace(-1, 0)

# 결측치 처리 (중앙값으로 대체)
# 이제 모든 변수가 숫자형이므로 에러가 발생하지 않음
X_filled = X.fillna(X.median())

# 무한대 값 처리
X_filled = X_filled.replace([np.inf, -np.inf], 0)

# 학습/테스트 분할
X_train, X_test, y_train, y_test = train_test_split(
    X_filled, y, test_size=0.2, random_state=42, stratify=y
)

# 간단한 Random Forest로 특성 중요도 평가
rf = RandomForestClassifier(n_estimators=100, random_state=42, class_weight='balanced')
rf.fit(X_train, y_train)

# 특성 중요도 추출
feature_importance = pd.DataFrame({
    'feature': X.columns,
    'importance': rf.feature_importances_
}).sort_values('importance', ascending=False)

print("\n🎯 상위 20개 중요 특성 (Random Forest 기준)")
print("="*60)
print(feature_importance.head(20).to_string(index=False))

# 시각화
fig = go.Figure()
fig.add_trace(go.Bar(
    y=feature_importance.head(20)['feature'].values[::-1],
    x=feature_importance.head(20)['importance'].values[::-1],
    orientation='h',
    marker_color='lightblue'
))

fig.update_layout(
    title='도메인 기반 특성 중요도 (상위 20개)',
    xaxis_title='Feature Importance',
    yaxis_title='특성명',
    height=600
)
fig.show()

# 간단한 성능 평가
y_pred_proba = rf.predict_proba(X_test)[:, 1]
roc_auc = roc_auc_score(y_test, y_pred_proba)
pr_auc = average_precision_score(y_test, y_pred_proba)

print(f"\n📊 초기 모델 성능 (도메인 특성만 사용)")
print(f"ROC-AUC: {roc_auc:.4f}")
print(f"PR-AUC: {pr_auc:.4f}")
```

**출력:**

```
🎯 상위 20개 중요 특성 (Random Forest 기준)
============================================================
   feature  importance
이해관계자_불신지수    0.115817
    신용등급점수    0.083416
     연체심각도    0.033175
   조기경보신호수    0.029903
     총연체건수    0.028992
 종합부도위험스코어    0.027431
      연체여부    0.025684
    재무레버리지    0.024257
    부채레버리지    0.023730
    부채상환년수    0.020146
    매출총이익률    0.020110
     순부채비율    0.019389
     이자부담률    0.019175
   기업규모_로그    0.019031
      판관비율    0.018474
      운전자본    0.018116
   시장포지션지수    0.018044
    단기부채비중    0.017896
   유동성압박지수    0.017864
    이자보상배율    0.017796
```

```
📊 초기 모델 성능 (도메인 특성만 사용)
ROC-AUC: 0.8235
PR-AUC: 0.1151
```

---

## 11. 핵심 인사이트 정리


### 코드 셀 #16

```python
print("\n" + "="*80)
print("📌 도메인 기반 특성 공학 - 핵심 인사이트")
print("="*80)

insights = [
    "1. 유동성 위기 조기 감지: 현금소진일수, 운전자본 건전성 등 즉각적 지급능력 특성 생성",
    "2. 지급불능 패턴: 자본잠식도, 부채상환년수 등 장기 지급능력 평가 지표 구현",
    "3. 재무조작 탐지: 한국형 M-Score를 통한 회계 이상 징후 포착",
    "4. 한국 시장 특화: 대기업 의존도, 제조업 특성, 외감 여부 등 한국 기업 특성 반영",
    "5. 이해관계자 신뢰: 연체, 세금체납, 신용등급 등 외부 신뢰도 지표 통합",
    "6. 복합 리스크 지표: 다양한 도메인 지식을 통합한 종합 위험 스코어 개발",
    "7. 비선형 관계: 제곱, 로그, 상호작용 항을 통한 복잡한 패턴 포착"
]

for insight in insights:
    print(insight)

print("\n" + "="*80)
print("🎯 다음 단계 권장사항")
print("="*80)

recommendations = [
    "1. 상관관계 분석을 통한 다중공선성 제거",
    "2. Information Value 계산을 통한 특성 선택",
    "3. SMOTE + Tomek Links 적용 전 특성 스케일링",
    "4. 카테고리별 특성 중요도 기반 가중 앙상블 모델 구축",
    "5. SHAP 분석을 통한 특성 기여도 해석"
]

for rec in recommendations:
    print(rec)
```

**출력:**

```
================================================================================
📌 도메인 기반 특성 공학 - 핵심 인사이트
================================================================================
1. 유동성 위기 조기 감지: 현금소진일수, 운전자본 건전성 등 즉각적 지급능력 특성 생성
2. 지급불능 패턴: 자본잠식도, 부채상환년수 등 장기 지급능력 평가 지표 구현
3. 재무조작 탐지: 한국형 M-Score를 통한 회계 이상 징후 포착
4. 한국 시장 특화: 대기업 의존도, 제조업 특성, 외감 여부 등 한국 기업 특성 반영
5. 이해관계자 신뢰: 연체, 세금체납, 신용등급 등 외부 신뢰도 지표 통합
6. 복합 리스크 지표: 다양한 도메인 지식을 통합한 종합 위험 스코어 개발
7. 비선형 관계: 제곱, 로그, 상호작용 항을 통한 복잡한 패턴 포착

================================================================================
🎯 다음 단계 권장사항
================================================================================
1. 상관관계 분석을 통한 다중공선성 제거
2. Information Value 계산을 통한 특성 선택
3. SMOTE + Tomek Links 적용 전 특성 스케일링
4. 카테고리별 특성 중요도 기반 가중 앙상블 모델 구축
5. SHAP 분석을 통한 특성 기여도 해석
```

---
